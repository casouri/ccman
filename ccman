#!/bin/bash
set -e

SRC_DIR="$HOME/p/ccman"

usage() {
  echo "Usage: ccode <command> [args]"
  echo ""
  echo "Commands:"
  echo "  claude [project-dir]  Start Claude Code for a project (default: cwd)"
  echo "  gemini [project-dir]  Start Gemini for a project (default: cwd)"
  echo "  stop [project-dir]    Stop the colima instance for a project (default: cwd)"
  echo "  list                  List all Claude Code instances"
  echo "  clean [project-dir]   Remove colima and docker instance for a project (default: cwd)"
  echo "  clean-image [project-dir]  Remove the agent-image docker image for a project (default: cwd)"
  exit 1
}

cmd_run() {
  PROVIDER=$1
  PROJECT_DIR="${2:-$(pwd)}"
  PROJECT_DIR="$(realpath "$PROJECT_DIR")"

  # Translate macOS path to Linux path for container
  CONTAINER_DIR=$(echo "$PROJECT_DIR" | sed "s|^$HOME/|/home/|")

  PROFILE="cc-$(echo "$PROJECT_DIR" | sed 's|^/||; s|[/ ]|-|g')"

  echo "Project:  $PROJECT_DIR"
  echo "Profile:  $PROFILE"

  local api_key_name
  local exec_args

  case "$PROVIDER" in
    claude)
      api_key_name="anthropic-api-key"
      exec_args="claude --dangerously-skip-permissions"
      ;;
    gemini)
      api_key_name="gemini-api-key"
      exec_args="gemini --approval-mode=yolo"
      ;;
    *)
      echo "Unknown provider: $PROVIDER"
      exit 1
      ;;
  esac

  API_KEY=$(security find-generic-password -s "$api_key_name" -w) \
    || { echo "API key not found in keychain. Add it with:"; \
         echo "  security add-generic-password -s $api_key_name -a \$USER -w"; \
         exit 1; }

  # Start Colima profile if not already running
  if ! colima status "$PROFILE" &>/dev/null; then
    echo "Starting Colima profile '$PROFILE'..."
    colima start "$PROFILE" \
      # Don’t set docker’s global context.
      --activate=false \
      --cpu 1 \
      --memory 1 \
      --disk 20 \
      --mount "$PROJECT_DIR":w \
      --mount "$SRC_DIR/var":w \
      --mount-type virtiofs

    # Wait for Docker daemon to be ready
    echo "Waiting for Docker daemon..."
    for i in {1..30}; do
      if docker --context "colima-$PROFILE" info &>/dev/null; then
        break
      fi
      sleep 1
    done
  else
    echo "Colima profile '$PROFILE' already running."
  fi

  # Build image if not already built in this profile
  if ! docker --context "colima-$PROFILE" images -q agent-image | grep -q .; then
    echo "Building agent-image..."
    docker --context "colima-$PROFILE" build -t agent-image "$SRC_DIR"
  else
    echo "Image already exists, skipping build."
  fi

  # Check for existing running container
  EXISTING=$(docker --context "colima-$PROFILE" ps -q --filter ancestor=agent-image 2>/dev/null || true)
  if [ -n "$EXISTING" ]; then
    echo "Attaching to existing container..."
    docker --context "colima-$PROFILE" exec -it "$EXISTING" $exec_args
  else
    echo "Starting new container..."
    docker --context "colima-$PROFILE" run -it \
      -v "$PROJECT_DIR":"$CONTAINER_DIR" \
      -v "$SRC_DIR/var/.claude:/home/bob/.claude" \
      -v "$SRC_DIR/var/.gemini:/home/bob/.gemini" \
      -v "$SRC_DIR/var/.claude.json:/home/bob/.claude.json" \
      -e API_KEY="$API_KEY" \
      -e GEMINI_API_KEY="$API_KEY" \
      -w "$CONTAINER_DIR" \
      agent-image $exec_args
  fi
}

cmd_claude() {
  cmd_run "claude" "$@"
}

cmd_gemini() {
  cmd_run "gemini" "$@"
}

cmd_stop() {
  PROJECT_DIR="${1:-$(pwd)}"
  PROJECT_DIR="$(realpath "$PROJECT_DIR")"

  PROFILE="cc-$(echo "$PROJECT_DIR" | sed 's|^/||; s|[/ ]|-|g')"

  echo "Project:  $PROJECT_DIR"
  echo "Profile:  $PROFILE"

  if colima status "$PROFILE" &>/dev/null; then
    echo "Stopping colima profile '$PROFILE'..."
    colima stop "$PROFILE"
    echo "Stopped."
  else
    echo "Colima profile '$PROFILE' is not running."
  fi
}

cmd_list() {
  colima list 2>/dev/null | awk '
    NR == 1 { print; next }
    /^cc-/ {
      profile = $1
      # Reverse the profile name to a path: strip "cc-" prefix, replace dashes with slashes
      path = profile
      sub(/^cc-/, "", path)
      gsub(/-/, "/", path)
      path = "/" path
      $1 = profile
      printf "%-40s %-30s %s %s %s\n", profile, path, $2, $3, $4
    }
  '
}

cmd_clean() {
  PROJECT_DIR="${1:-$(pwd)}"
  PROJECT_DIR="$(realpath "$PROJECT_DIR")"

  PROFILE="cc-$(echo "$PROJECT_DIR" | sed 's|^/||; s|[/ ]|-|g')"

  echo "Project:  $PROJECT_DIR"
  echo "Profile:  $PROFILE"

  # Check if colima profile exists
  if ! colima list 2>/dev/null | grep -q "^$PROFILE "; then
    echo "No colima instance found for profile '$PROFILE'."
  fi

  # Remove all docker containers in this profile
  CONTAINERS=$(docker --context "colima-$PROFILE" ps -aq 2>/dev/null || true)
  if [ -n "$CONTAINERS" ]; then
    echo "Removing docker containers..."
    docker --context "colima-$PROFILE" rm -f $CONTAINERS
  fi

  # Remove all docker images in this profile
  IMAGES=$(docker --context "colima-$PROFILE" images -q 2>/dev/null || true)
  if [ -n "$IMAGES" ]; then
    echo "Removing docker images..."
    docker --context "colima-$PROFILE" rmi -f $IMAGES
  fi

  # Stop and delete colima profile
  echo "Stopping and deleting colima profile '$PROFILE'..."
  colima stop "$PROFILE" 2>/dev/null || true
  colima delete "$PROFILE" -f

  echo "Cleaned up profile '$PROFILE'."
}

cmd_clean_image() {
  PROJECT_DIR="${1:-$(pwd)}"
  PROJECT_DIR="$(realpath "$PROJECT_DIR")"

  PROFILE="cc-$(echo "$PROJECT_DIR" | sed 's|^/||; s|[/ ]|-|g')"

  echo "Project:  $PROJECT_DIR"
  echo "Profile:  $PROFILE"

  # Check if colima profile is running
  if ! colima status "$PROFILE" &>/dev/null; then
    echo "Colima profile '$PROFILE' is not running."
  fi

  # Remove the agent-image image
  if docker --context "colima-$PROFILE" images -q agent-image | grep -q .; then
    echo "Removing agent-image image..."
    docker --context "colima-$PROFILE" rmi -f agent-image
    echo "Image removed."
  else
    echo "No agent-image image found."
  fi
}

# Main
case "${1:-}" in
  claude) shift; cmd_claude "$@" ;;
  gemini) shift; cmd_gemini "$@" ;;
  stop)  shift; cmd_stop "$@" ;;
  list)  cmd_list ;;
  clean) shift; cmd_clean "$@" ;;
  clean-image) shift; cmd_clean_image "$@" ;;
  *)     usage ;;
esac
